This is the current working version of the code.
